name: CAB WSL - Build and release

on:
  push:
    tags:
      - 'wsl-cab-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

concurrency:
  group: wsl-cab-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-release:
    name: Build & Release
    runs-on: ubuntu-24.04
    steps:
      - name: Derive version from tag or input
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="v${{ inputs.version }}"
            echo "Using manual input version: $version"
          else
            ref="${GITHUB_REF_NAME}"
            if [[ "$ref" =~ ^wsl-cab-v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              version="v${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.${BASH_REMATCH[3]}"
            else
              echo "Tag name must be wsl-cab-vx.y.z, got: $ref" >&2
              exit 1
            fi
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Purge bloat
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'rampage'
          witness-carnage: true

      - name: Install Nix
        uses: NixOS/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Verify Nix
        run: nix --version

      - name: Flake checker
        uses: DeterminateSystems/flake-checker-action@main
        with:
          fail-mode: true

      - name: Build
        id: build
        shell: bash
        run: |
          set -euo pipefail

          workdir="$PWD"
          rm -f "$workdir"/nixos*.wsl "$workdir"/*.wsl "$workdir"/nixos*.tar "$workdir"/*.tar "$workdir"/nixos*.tar.gz "$workdir"/*.tar.gz || true

          sudo /nix/var/nix/profiles/default/bin/nix run ".#nixosConfigurations.wsl-cab.config.system.build.tarballBuilder"

          if [[ -f "$GITHUB_WORKSPACE/nixos.wsl" ]]; then
            artifact_path="$GITHUB_WORKSPACE/nixos.wsl"
          else
            echo "\"$GITHUB_WORKSPACE/nixos.wsl\" not found" >&2
            exit 1
          fi

          echo "Built artifact: $artifact_path"
          echo "artifact=$artifact_path" >> "$GITHUB_OUTPUT"

      - name: Upload build artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: nixos-${{ steps.meta.outputs.version }}.wsl
          path: ${{ steps.build.outputs.artifact }}
          if-no-files-found: error
          compression-level: 0
          retention-days: 30

      - name: Release
        id: release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail

          tag="${{ steps.meta.outputs.version }}"

          # Create and push tag if manually triggered
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Creating and pushing tag: $tag"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$tag" -m "Release $tag"
            git push origin "$tag"
          fi

          notes=$(cat <<EOF
          Download the WSL artifact from this workflow run (Artifacts section):

          https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}#artifacts

          Artifact name: nixos-${version}.wsl
          EOF
          )

          if gh release view "$tag" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "Release $tag already exists; updating notes"
            gh release edit "$tag" --notes "$notes" --repo "$GITHUB_REPOSITORY"
          else
            gh release create "$tag" \
                --repo="$GITHUB_REPOSITORY" \
                --title="WSL CAB ${version}" \
                --notes "$notes" \
                --draft
          fi
